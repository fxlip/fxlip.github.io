---
layout: page
title: 404
permalink: /404.html
hide_header: true
hide_footer: true
---

<div class="terminal-box" id="profile-terminal">
  <div class="terminal-header">
    <div class="terminal-controls">
      <div class="win-btn btn-min" title="Minimize">−</div>
      <div class="win-btn btn-close" title="Close">✕</div>
    </div>
  </div>
  <div class="terminal-body" id="terminal-body">
    <div id="profile-loading">
      <span class="t-user">fxlip</span><span class="t-gray">@</span><span class="t-host">www</span><span class="t-gray">:</span><span class="t-path">~</span><span class="t-gray">$</span> <span class="t-cmd" id="cmd-display">cd ...</span>
    </div>
    <div class="t-out" id="err-display">carregando...</div>
  </div>
</div>

<script>
(function() {
  var BLACKLIST = new Set([
    'linux','sobre','setup','manifesto','arquivos','feed','www','fxlip','infosec',
    'busca','s','x','404','robots','sitemap','assets','files','favicon','api','admin',
    'u','p','tag','category','page','search','post','posts'
  ]);

  var WORKER_URL = document.body.dataset.workerUrl;
  var FP_KEY = 'fxlip_fp';
  var NAME_KEY = 'fxlip_visitor_name';

  var pathSegment = location.pathname.slice(1).split('/')[0].toLowerCase();

  function esc(s) {
    return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function formatDate(iso) {
    if (!iso) return '?';
    return new Date(iso).toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
  }

  function formatTime(secs) {
    if (!secs) return '0min';
    var h = Math.floor(secs / 3600);
    var m = Math.floor((secs % 3600) / 60);
    if (h > 0) return h + 'h ' + (m > 0 ? m + 'min' : '');
    return m + 'min';
  }

  function renderHeatmap(clusterJson) {
    var cluster = {};
    try { cluster = JSON.parse(clusterJson || '{}'); } catch (_) {}
    var hourData = cluster.hour || {};
    var vals = Object.values(hourData).map(Number);
    var maxVal = vals.length ? Math.max.apply(null, vals) : 1;
    if (maxVal < 1) maxVal = 1;
    var periods = [[0,1,2,3,4,5],[6,7,8,9,10,11],[12,13,14,15,16,17],[18,19,20,21,22,23]];
    var plabels = ['00–05','06–11','12–17','18–23'];
    var rows = periods.map(function(hours, i) {
      var cells = hours.map(function(h) {
        var n = hourData[String(h)] || 0;
        var lv = n === 0 ? 0 : n <= maxVal * 0.25 ? 1 : n <= maxVal * 0.5 ? 2 : n <= maxVal * 0.75 ? 3 : 4;
        return '<span class="gh-cell gh-lv' + lv + '" title="' + (h < 10 ? '0' : '') + h + 'h: ' + n + '"></span>';
      }).join('');
      return '<div class="gh-row"><span class="gh-lbl t-gray">' + plabels[i] + '</span><div class="gh-cells">' + cells + '</div></div>';
    }).join('');
    return '<div class="gh-heatmap">' + rows + '</div>';
  }

  function show404(path) {
    var displayPath = path.length > 30 ? path.substring(0, 27) + '...' : path;
    document.getElementById('cmd-display').textContent = 'cd ' + displayPath;
    document.getElementById('err-display').innerHTML =
      'bash: cd: ' + esc(displayPath) + ': Arquivo ou diretório inexistente.<br>Voltar pro <a href=\'/\' class=\'mention-link\'>@feed</a>?';
  }

  function gravatarUrl(hash, size) {
    return 'https://www.gravatar.com/avatar/' + (hash || '00000000000000000000000000000000') + '?s=' + (size || 80) + '&d=identicon';
  }

  function renderProfile(username, data, fingerprint) {
    var body = document.getElementById('terminal-body');

    var storedName = null;
    try { storedName = localStorage.getItem(NAME_KEY); } catch (_) {}
    var isMine = !!(storedName && storedName.toLowerCase() === username.toLowerCase() && fingerprint);

    var since    = formatDate(data.first_seen);
    var geo      = [data.city, data.country].filter(Boolean).join(', ') || '?';
    var timeStr  = formatTime(data.total_time_spent);
    var visits   = (data.visits_count || 0).toLocaleString('pt-BR');
    var comments = (data.interactions && data.interactions.comments) || 0;
    var upvotes  = (data.interactions && data.interactions.likes)    || 0;
    var avatarSrc      = WORKER_URL + '/api/user/' + encodeURIComponent(username) + '/avatar';
    var avatarFallback = gravatarUrl(data.gravatar_hash, 80);

    var socialLinks = '';
    if (data.instagram) socialLinks += '<a href="https://instagram.com/' + esc(data.instagram) + '" class="file-link" target="_blank" rel="noopener">ig/' + esc(data.instagram) + '</a>';
    if (data.twitter)   socialLinks += '<a href="https://x.com/' + esc(data.twitter) + '" class="file-link" target="_blank" rel="noopener">x/' + esc(data.twitter) + '</a>';

    // Seção 1: header
    var sec1 = '<div class="ps-header">'
      + '<img id="profile-avatar" class="profile-avatar" src="' + esc(avatarSrc) + '" onerror="this.onerror=null;this.src=\'' + esc(avatarFallback) + '\'" alt="' + esc(username) + '" width="80" height="80">'
      + '<div class="ps-header-info">'
      + '<div class="ps-name">@' + esc(username) + (isMine ? ' <span class="profile-badge">[você]</span>' : '') + '</div>'
      + '<div class="ps-meta t-gray">' + esc(geo) + ' · desde ' + esc(since) + '</div>'
      + (socialLinks ? '<div class="ps-social">' + socialLinks + '</div>' : '')
      + '</div>'
      + '</div>';

    // Seção 2: uso + atividade (sem títulos)
    var sec2 = '<div class="ps-two-col">'
      + '<div class="ps-block">'
      + '<div class="ps-stat-row">'
      + '<div class="ps-stat"><span class="ps-val">' + esc(visits) + '</span><span class="t-gray"> visitas</span></div>'
      + '<div class="ps-stat"><span class="ps-val">' + esc(timeStr) + '</span><span class="t-gray"> no site</span></div>'
      + '</div>'
      + '<div class="ps-stat-row">'
      + '<div class="ps-stat"><span class="ps-val">' + esc(String(comments)) + '</span><span class="t-gray"> comentários</span></div>'
      + '<div class="ps-stat"><span class="ps-val">' + esc(String(upvotes)) + '</span><span class="t-gray"> upvotes</span></div>'
      + '</div>'
      + '</div>'
      + '<div class="ps-block">'
      + renderHeatmap(data.activity_cluster)
      + '<div id="profile-activity-section"></div>'
      + '</div>'
      + '</div>';

    // Seção 3: terminal de edição (apenas dono)
    var P = '<span class="t-user">' + esc(username) + '</span><span class="t-gray">@</span><span class="t-host">www</span><span class="t-gray">:~$&nbsp;</span>';
    var sec3 = isMine
      ? ''
        + '<div class="ps-terminal">'
        + '<div class="ps-term-line" id="tl-email">' + P + '<span class="t-cmd">export EMAIL=</span><input type="email" id="pf-email" class="ps-term-input" placeholder="seu@email.com" maxlength="254" autocomplete="off" spellcheck="false"></div>'
        + '<div class="ps-term-line" id="tl-gender">' + P + '<span class="t-cmd">export GENDER=</span><select id="pf-gender" class="ps-term-input"><option value="">--</option><option value="m">m</option><option value="f">f</option><option value="nb">nb</option></select></div>'
        + '<div class="ps-term-line" id="tl-instagram">' + P + '<span class="t-cmd">export INSTAGRAM=</span><input type="text" id="pf-instagram" class="ps-term-input" placeholder="handle" maxlength="30" autocomplete="off" spellcheck="false"><span class="ps-tc-pub">&nbsp;# público</span></div>'
        + '<div class="ps-term-line" id="tl-twitter">' + P + '<span class="t-cmd">export TWITTER=</span><input type="text" id="pf-twitter" class="ps-term-input" placeholder="handle" maxlength="15" autocomplete="off" spellcheck="false"><span class="ps-tc-pub">&nbsp;# público</span></div>'
        + '<div class="ps-term-line" id="tl-whatsapp">' + P + '<span class="t-cmd">export NUMERO=</span><input type="tel" id="pf-whatsapp" class="ps-term-input" placeholder="+55 11 99999-9999" maxlength="20" autocomplete="off" spellcheck="false"><span class="ps-tc-priv">&nbsp;# privado</span></div>'
        + '<div class="ps-term-line ps-term-locked">' + P + '<span class="t-gray">LOCATION=</span><span class="t-gray">' + esc(geo) + '</span><span class="ps-tc-priv">&nbsp;# auto-detect</span></div>'
        + '</div>'
        + '<div id="profile-save-status" class="t-gray ps-save-status"></div>'
      : '';

    body.innerHTML = '<div class="ps">' + sec1 + sec2 + sec3 + '</div>';
    document.title = '@' + username;

    // Carrega atividade recente
    if (WORKER_URL) {
      fetch(WORKER_URL + '/api/user/' + encodeURIComponent(username) + '/activity')
        .then(function(r) { return r.json(); })
        .then(function(actData) {
          var section = document.getElementById('profile-activity-section');
          if (!section) return;
          var acts = actData.activities || [];
          if (acts.length === 0) { section.innerHTML = ''; return; }
          var items = acts.map(function(a) {
            var dateStr = a.created_at ? new Date(a.created_at).toLocaleDateString('pt-BR') : '';
            var icon = a.type === 'comment' ? '>' : a.type === 'like' ? '♥' : '▲';
            var content = a.content ? ' "' + esc(a.content.substring(0, 80)) + (a.content.length > 80 ? '...' : '') + '"' : '';
            return '<div class="profile-activity-item"><span class="t-gray">' + icon + '</span>'
              + ' <a href="/' + esc(a.target_slug) + '" class="file-link">' + esc(a.target_slug) + '</a>'
              + content
              + ' <span class="t-gray">' + esc(dateStr) + '</span></div>';
          }).join('');
          section.innerHTML = items;
        }).catch(function() {});
    }

    // Terminal de edição: masks + lock-on-enter
    if (isMine && WORKER_URL) {
      var ownerFields = [
        { id: 'pf-email',     lineId: 'tl-email',    mask: null },
        { id: 'pf-gender',    lineId: 'tl-gender',   mask: null },
        { id: 'pf-instagram', lineId: 'tl-instagram', mask: 'handle' },
        { id: 'pf-twitter',   lineId: 'tl-twitter',  mask: 'handle' },
        { id: 'pf-whatsapp',  lineId: 'tl-whatsapp', mask: 'phone' },
      ];

      function maskHandle(el) {
        el.addEventListener('input', function() {
          el.value = el.value.replace(/^@+/, '').replace(/[^a-zA-Z0-9._\-]/g, '');
        });
      }

      function maskPhone(el) {
        el.addEventListener('input', function() {
          var d = el.value.replace(/\D/g, '').slice(0, 13);
          var r = '';
          if (d.length > 0) r  = '+' + d.slice(0, 2);
          if (d.length > 2) r += ' ' + d.slice(2, 4);
          if (d.length > 4) r += ' ' + d.slice(4, 9);
          if (d.length > 9) r += '-' + d.slice(9, 13);
          el.value = r;
        });
      }

      function lockField(fieldId, lineId) {
        var el = document.getElementById(fieldId);
        var line = document.getElementById(lineId);
        if (el) el.disabled = true;
        if (line) line.classList.add('ps-term-saved');
      }

      function saveProfile() {
        var status = document.getElementById('profile-save-status');
        var emailVal  = (document.getElementById('pf-email')     || {}).value || '';
        var genderVal = (document.getElementById('pf-gender')    || {}).value || '';
        var igVal     = (document.getElementById('pf-instagram') || {}).value || '';
        var twVal     = (document.getElementById('pf-twitter')   || {}).value || '';
        var waVal     = (document.getElementById('pf-whatsapp')  || {}).value || '';
        var payload = { fingerprint: fingerprint };
        if (emailVal)  payload.email     = emailVal.trim();
        if (genderVal) payload.gender    = genderVal;
        if (igVal)     payload.instagram = igVal.trim();
        if (twVal)     payload.twitter   = twVal.trim();
        if (waVal)     payload.whatsapp  = waVal.trim();
        fetch(WORKER_URL + '/api/profile', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        }).then(function(r) { return r.json(); })
          .then(function(res) {
            if (res.ok) {
              if (status) status.textContent = 'salvo.';
              if (emailVal.trim()) {
                var avatar = document.getElementById('profile-avatar');
                if (avatar) avatar.src = WORKER_URL + '/api/user/' + encodeURIComponent(username) + '/avatar?' + Date.now();
              }
            } else {
              if (status) status.textContent = res.error || 'erro ao salvar.';
            }
          }).catch(function() { if (status) status.textContent = 'erro ao salvar.'; });
      }

      ownerFields.forEach(function(item) {
        var el = document.getElementById(item.id);
        if (!el) return;
        if (item.mask === 'handle') maskHandle(el);
        if (item.mask === 'phone')  maskPhone(el);
        el.addEventListener('keydown', function(e) {
          if (e.key !== 'Enter') return;
          e.preventDefault();
          saveProfile();
          lockField(item.id, item.lineId);
        });
      });
    }
  }

  // -- MAIN --
  if (!pathSegment || BLACKLIST.has(pathSegment) || !/^[a-z0-9à-ú][a-z0-9à-ú-]{0,28}[a-z0-9à-ú]?$/.test(pathSegment) || !WORKER_URL) {
    show404(location.pathname);
    return;
  }

  var fingerprint = null;
  try { fingerprint = localStorage.getItem(FP_KEY); } catch (_) {}

  fetch(WORKER_URL + '/api/user/' + encodeURIComponent(pathSegment))
    .then(function(res) {
      if (res.status === 404) { show404(location.pathname); return null; }
      return res.json();
    })
    .then(function(data) {
      if (!data) return;
      if (data.error) { show404(location.pathname); return; }
      renderProfile(pathSegment, data, fingerprint);
    })
    .catch(function() { show404(location.pathname); });
})();
</script>
