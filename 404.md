---
layout: page
title: 404
permalink: /404.html
hide_header: true
hide_footer: true
---

<div class="terminal-box" id="profile-terminal">
  <div class="terminal-header">
    <div class="terminal-controls">
      <div class="win-btn btn-min" title="Minimize">−</div>
      <div class="win-btn btn-close" title="Close">✕</div>
    </div>
  </div>
  <div class="terminal-body" id="terminal-body">
    <div id="profile-loading">
      <span class="t-user">fxlip</span><span class="t-gray">@</span><span class="t-host">www</span><span class="t-gray">:</span><span class="t-path">~</span><span class="t-gray">$</span> <span class="t-cmd" id="cmd-display">cd ...</span>
    </div>
    <div class="t-out" id="err-display">carregando...</div>
  </div>
</div>

<script>
(function() {
  var BLACKLIST = new Set([
    'linux','sobre','setup','manifesto','arquivos','feed','www','fxlip','infosec',
    'busca','s','x','404','robots','sitemap','assets','files','favicon','api','admin',
    'u','p','tag','category','page','search','post','posts'
  ]);

  var WORKER_URL = document.body.dataset.workerUrl;
  var FP_KEY = 'fxlip_fp';
  var NAME_KEY = 'fxlip_visitor_name';

  var pathSegment = location.pathname.slice(1).split('/')[0].toLowerCase();

  function esc(s) {
    return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function formatDate(iso) {
    if (!iso) return '?';
    return new Date(iso).toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
  }

  function formatTime(secs) {
    if (!secs) return '0min';
    var h = Math.floor(secs / 3600);
    var m = Math.floor((secs % 3600) / 60);
    if (h > 0) return h + 'h ' + (m > 0 ? m + 'min' : '');
    return m + 'min';
  }

  function renderHeatmap(clusterJson) {
    var cluster = {};
    try { cluster = JSON.parse(clusterJson || '{}'); } catch (_) {}
    var hourData = cluster.hour || {};
    var vals = Object.values(hourData).map(Number);
    var maxVal = vals.length ? Math.max.apply(null, vals) : 1;
    if (maxVal < 1) maxVal = 1;
    var cells = '';
    for (var h = 0; h < 24; h++) {
      var n = hourData[String(h)] || 0;
      var intensity = (n / maxVal).toFixed(2);
      var label = (h < 10 ? '0' : '') + h + 'h';
      cells += '<span class="heatmap-cell" title="' + label + ': ' + n + '" style="--intensity:' + intensity + '"></span>';
    }
    return '<div class="profile-heatmap">' + cells + '</div>';
  }

  function show404(path) {
    var displayPath = path.length > 30 ? path.substring(0, 27) + '...' : path;
    document.getElementById('cmd-display').textContent = 'cd ' + displayPath;
    document.getElementById('err-display').innerHTML =
      'bash: cd: ' + esc(displayPath) + ': Arquivo ou diretório inexistente.<br>Voltar pro <a href=\'/\' class=\'mention-link\'>@feed</a>?';
  }

  function gravatarUrl(hash, size) {
    return 'https://www.gravatar.com/avatar/' + (hash || '00000000000000000000000000000000') + '?s=' + (size || 80) + '&d=identicon';
  }

  function gravatarHashFromEmail(email) {
    return crypto.subtle.digest('SHA-256', new TextEncoder().encode(email.trim().toLowerCase()))
      .then(function(buf) {
        return Array.from(new Uint8Array(buf)).map(function(b) { return b.toString(16).padStart(2,'0'); }).join('');
      });
  }

  function renderProfile(username, data, fingerprint) {
    var body = document.getElementById('terminal-body');

    var storedName = null;
    try { storedName = localStorage.getItem(NAME_KEY); } catch (_) {}
    var isMine = !!(storedName && storedName.toLowerCase() === username.toLowerCase() && fingerprint);

    var since   = formatDate(data.first_seen);
    var geo     = [data.city, data.country].filter(Boolean).join(', ') || '?';
    var timeStr = formatTime(data.total_time_spent);
    var visits  = (data.visits_count || 0).toLocaleString('pt-BR');
    var comments = (data.interactions && data.interactions.comments) || 0;
    var likes    = (data.interactions && data.interactions.likes)    || 0;
    var avatarSrc = WORKER_URL + '/api/user/' + encodeURIComponent(username) + '/avatar';
    var avatarFallback = gravatarUrl(data.gravatar_hash, 80);

    var ownerZone = isMine
      ? '<hr class="t-hr">'
        + '<div class="profile-owner-zone">'
        + '<div class="t-gray">── editar perfil ──</div>'
        + '<div class="profile-field"><span class="t-cmd">$ export EMAIL=</span>'
        + '<input type="email" id="pf-email" class="greeting-input" placeholder="seu@email.com" maxlength="254" autocomplete="off" spellcheck="false"></div>'
        + '<div class="profile-field"><span class="t-cmd">$ export GENDER=</span>'
        + '<select id="pf-gender" class="greeting-input"><option value="">--</option><option value="m">m</option><option value="f">f</option><option value="nb">nb</option></select></div>'
        + '<div class="profile-field"><span class="t-cmd">$ export INSTAGRAM=</span>'
        + '<input type="text" id="pf-instagram" class="greeting-input" placeholder="handle" maxlength="30" autocomplete="off" spellcheck="false"></div>'
        + '<div class="profile-field"><span class="t-cmd">$ export TWITTER=</span>'
        + '<input type="text" id="pf-twitter" class="greeting-input" placeholder="handle" maxlength="15" autocomplete="off" spellcheck="false"></div>'
        + '<div class="profile-field"><span class="t-cmd">$ export WHATSAPP=</span>'
        + '<input type="tel" id="pf-whatsapp" class="greeting-input" placeholder="+55 11 99999-9999" maxlength="20" autocomplete="off" spellcheck="false"></div>'
        + '<div id="profile-save-status" class="t-gray" style="margin-top:0.4em;font-size:0.85em"></div>'
        + '</div>'
      : '';

    var socialLinks = '';
    if (data.instagram) socialLinks += ' <a href="https://instagram.com/' + esc(data.instagram) + '" class="file-link" target="_blank" rel="noopener">ig/@' + esc(data.instagram) + '</a>';
    if (data.twitter)   socialLinks += ' <a href="https://x.com/' + esc(data.twitter) + '" class="file-link" target="_blank" rel="noopener">x/@' + esc(data.twitter) + '</a>';

    body.innerHTML =
      '<div class="profile-header">'
      + '<img id="profile-avatar" class="profile-avatar" src="' + esc(avatarSrc) + '" onerror="this.onerror=null;this.src=\'' + esc(avatarFallback) + '\'" alt="' + esc(username) + '" width="80" height="80">'
      + '<div class="profile-info">'
      + '<div class="profile-name">@' + esc(username) + (isMine ? ' <span class="profile-badge">[você]</span>' : '') + '</div>'
      + '<div class="t-gray">' + esc(geo) + ' · desde ' + esc(since) + '</div>'
      + (socialLinks ? '<div class="profile-social">' + socialLinks + '</div>' : '')
      + '</div>'
      + '</div>'
      + '<div class="t-gray profile-divider">── stats ──────────────────────────────</div>'
      + '<div class="profile-stats">'
      + '<div><span class="profile-stat-val">' + esc(visits) + '</span><span class="t-gray"> visitas</span></div>'
      + '<div><span class="profile-stat-val">' + esc(timeStr) + '</span><span class="t-gray"> no site</span></div>'
      + '<div><span class="profile-stat-val">' + esc(String(comments)) + '</span><span class="t-gray"> comentários</span></div>'
      + '<div><span class="profile-stat-val">' + esc(String(likes)) + '</span><span class="t-gray"> likes</span></div>'
      + '</div>'
      + '<div class="t-gray profile-divider">── atividade por hora ──────────────────</div>'
      + renderHeatmap(data.activity_cluster)
      + '<div id="profile-activity-section">'
      + '<div class="t-gray profile-divider">── carregando... ────────────────────────</div>'
      + '</div>'
      + ownerZone;

    // Carrega atividade recente
    if (WORKER_URL) {
      fetch(WORKER_URL + '/api/user/' + encodeURIComponent(username) + '/activity')
        .then(function(r) { return r.json(); })
        .then(function(actData) {
          var section = document.getElementById('profile-activity-section');
          if (!section) return;
          var acts = actData.activities || [];
          if (acts.length === 0) {
            section.innerHTML = '<div class="t-gray profile-divider">── sem atividade registrada ─────────────</div>';
            return;
          }
          var items = acts.map(function(a) {
            var dateStr = a.created_at ? new Date(a.created_at).toLocaleDateString('pt-BR') : '';
            var icon = a.type === 'comment' ? '>' : a.type === 'like' ? '♥' : '▲';
            var content = a.content ? ' "' + esc(a.content.substring(0, 80)) + (a.content.length > 80 ? '...' : '') + '"' : '';
            return '<div class="profile-activity-item"><span class="t-gray">' + icon + '</span>'
              + ' <a href="/' + esc(a.target_slug) + '" class="file-link">' + esc(a.target_slug) + '</a>'
              + content
              + ' <span class="t-gray">' + esc(dateStr) + '</span></div>';
          }).join('');
          section.innerHTML = '<div class="t-gray profile-divider">── atividade recente ─────────────────────</div>' + items;
        }).catch(function() {});
    }

    // Owner zone: salva perfil ao pressionar Enter em qualquer campo
    if (isMine && WORKER_URL) {
      var ownerFields = ['pf-email','pf-gender','pf-instagram','pf-twitter','pf-whatsapp'];
      function saveProfile() {
        var status = document.getElementById('profile-save-status');
        var emailVal    = (document.getElementById('pf-email')     || {}).value || '';
        var genderVal   = (document.getElementById('pf-gender')    || {}).value || '';
        var igVal       = (document.getElementById('pf-instagram') || {}).value || '';
        var twVal       = (document.getElementById('pf-twitter')   || {}).value || '';
        var waVal       = (document.getElementById('pf-whatsapp')  || {}).value || '';
        var payload = { fingerprint: fingerprint };
        if (emailVal)  payload.email     = emailVal.trim();
        if (genderVal) payload.gender    = genderVal;
        if (igVal)     payload.instagram = igVal.trim();
        if (twVal)     payload.twitter   = twVal.trim();
        if (waVal)     payload.whatsapp  = waVal.trim();
        fetch(WORKER_URL + '/api/profile', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        }).then(function(r) { return r.json(); })
          .then(function(res) {
            if (res.ok) {
              if (status) status.textContent = 'salvo.';
              // Atualiza avatar se email foi informado
              if (emailVal.trim()) {
                var avatar = document.getElementById('profile-avatar');
                if (avatar) {
                  avatar.src = WORKER_URL + '/api/user/' + encodeURIComponent(username) + '/avatar?' + Date.now();
                }
              }
            } else {
              if (status) status.textContent = res.error || 'erro ao salvar.';
            }
          }).catch(function() { if (status) status.textContent = 'erro ao salvar.'; });
      }
      ownerFields.forEach(function(id) {
        var el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('keydown', function(e) {
          if (e.key !== 'Enter') return;
          e.preventDefault();
          saveProfile();
        });
      });
    }
  }

  // -- MAIN --
  if (!pathSegment || BLACKLIST.has(pathSegment) || !/^[a-z0-9à-ú][a-z0-9à-ú-]{0,28}[a-z0-9à-ú]?$/.test(pathSegment) || !WORKER_URL) {
    show404(location.pathname);
    return;
  }

  var fingerprint = null;
  try { fingerprint = localStorage.getItem(FP_KEY); } catch (_) {}

  fetch(WORKER_URL + '/api/user/' + encodeURIComponent(pathSegment))
    .then(function(res) {
      if (res.status === 404) { show404(location.pathname); return null; }
      return res.json();
    })
    .then(function(data) {
      if (!data) return;
      if (data.error) { show404(location.pathname); return; }
      renderProfile(pathSegment, data, fingerprint);
    })
    .catch(function() { show404(location.pathname); });
})();
</script>
